<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script>
    <!-- CSS Reset -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css">
    <!-- Milligram CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.css">
    <style type="text/css">
* {
  box-sizing: border-box;
}
body {
  font-family: Arial, Helvetica, sans-serif;
}
    </style>
  </head>
  <body>
    <h4>Your IP</h4>
    <div id='client-ip'></div>
    <h4>Status</h4>
    <div id='client-connection-status'></div>
    <h4>Your Logs</h4>
    <table id='client-logs'>
      <thead>
        <tr>
          <th>
            Timestamp
          </th>
          <th>
            Type
          </th>
          <th>
            Method
          </th>
          <th>
            Params
          </th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </body>
  <script type="text/javascript">
    let currentWebSocket

    const tableCells = ['timestamp', 'type', 'method', 'params']

    const updateIp = (ip) => {
      const ipDiv = document.getElementById("client-ip")
      if (ip) {
        ipDiv.textContent = ip
      } else {
        ipDiv.textContent = ""
      }
    }

    const setConnectionStatus = () => {
      const connectionDiv = document.getElementById("client-connection-status")
      connectionDiv.textContent = "connected"
    }

    const unsetConnectionStatus = () => {
      const connectionDiv = document.getElementById("client-connection-status")
      connectionDiv.textContent = "not connected"
    }

    const addLogEntry = (entry) => {
      const table = document.getElementById("client-logs")
      const tableBody = table.getElementsByTagName("tbody")[0]
      const tableRow = tableBody.insertRow(0)
      tableCells.forEach((name) => {
        const cell = tableRow.insertCell()
        const cellContent = document.createTextNode(entry[name])
        cell.appendChild(cellContent)
      })
    }

    const join = () => {
      const wsUrl = `wss://${location.host}/client_logs/websocket`
      const ws = new WebSocket(wsUrl)

      ws.addEventListener("open", event => {
        console.log("websocket opened")
        currentWebSocket = ws
        setConnectionStatus()
      })

      ws.addEventListener("message", event => {
        const data = JSON.parse(event.data)
        console.log("received websocket message", event.data)
        addLogEntry(data.log)
        updateIp(data.ip)
      })

      ws.addEventListener("close", event => {
        console.log("websocket closed, reconnecting:", event.code, event.reason)
        unsetConnectionStatus()
        join()
      })

      ws.addEventListener("error", event => {
        console.log("websocket error, reconnecting:", event)
        unsetConnectionStatus()
        join()
      })
    }

    window.addEventListener('load', async () => {
      unsetConnectionStatus()
      join()
    }, false)
  </script>
</html>
